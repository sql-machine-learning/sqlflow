language: go
branches:
  only:
  - gh-pages
  - "/.*/"
service:
- docker
addons:
  apt:
    packages:
    - docker-ce
install:
  # Note(tony): TravisCI's native `go get ${gobuild_args} ./...` failed with
  # `/usr/bin/ld: final link failed: Bad value`, the cause is the system linker
  # being not up to date: https://github.com/golang/go/issues/15038
  # So I decided to skip install, and go get inside sqlflow:dev image
  # Ref build: https://travis-ci.com/sql-machine-learning/sqlflow/builds/107870583
  - echo "skip install"

# NOTE: mount all $GOPATH into container, then after build and test,
# $GOPATH/bin will have expected binaries.
script:
  - set -e
  - ls -lah
  - docker build -t sqlflow:dev -f Dockerfile.dev .
  - docker run --rm -v $GOPATH/src:/go/src -w /go/src/github.com/sql-machine-learning/sqlflow sqlflow:dev pre-commit run -a
  - docker run --rm -v $GOPATH:/go -w /go/src/github.com/sql-machine-learning/sqlflow sqlflow:dev bash scripts/test.sh
  - docker run --rm -v $GOPATH:/go -w /go/src/github.com/sql-machine-learning/sqlflow sqlflow/gohive:dev bash scripts/test_hive.sh

deploy:
  skip_cleanup: true
  provider: script
  script: bash scripts/deploy.sh
  on:
    branch: develop
env:
  global:
    secure: JkZb2QeaBBA1PDUQLuLZhBvmC1lqtUhaPNdWKOP22yDwgvuMgR6Ok4ts2ff8FJghmhY+bpl9bAKi+8B6gVCOpx9944xqYwUaZokH1leyaMyvLgLwHNJXXaBm2r7S+ragX1gylQpNXnbpc4a9tiK1u23bqVxoJRl/WV33maBU96+2YswK+lRrlVXx8Qk+ldco45vCxeNVfyNA8cNnVw9VpZkXebOIDP7cXsfLUwaa09WVU3Y09HkQgg1plUU7ZBDc2tOkBq84rHjOgHlxNYwCNkhP9w7ZeglDDZjhIcfhnICG1lQOrLXLTQMqt/U+uQIX7vhVqCuisXRtLnvxIbL097DDoIsh4bDluZcD4NXux5BkQJA14vBF7bpk1289jFkkhRsFn6xoa09O1nj2HCMwUwC0e1EblX0VHVyYd1BKBWpVJWADXSuVvfqGsFs9TgByWxgx2PW8FLLe7m2CzNb9x8pqzYKCJNEdMZfEBEciHXqBF6TXf8p2IUc6uE06v26otsnMLRUFz06lqjWKk/u9KiTWIjMDk9j2xBccu7hb5zqmJAPSvX1aWOX8SCM9gIH75EL+WdT7Nkt0nM94/OxZVekuEo2E/tiL2X45SAy/DNBLdDLIQAMbi7BtP7hcGwtItHFZja7F5CXfkbFCxJ5FH4yUDz4I7Oht9ttKzsWjh2I=
